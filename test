/*****************************************************************
 *  Xtream Live v3.3 â€“ æ‰‹åŠ¨å¡«å‚ç‰ˆ
 *****************************************************************/

WidgetMetadata = {
    id: "xtream_live_v33",
    title: "Xtream Live v3.3",
    description: "HTTPS è‡ªé€‚åº”ã€åˆ†ç±»åˆ†é¡µã€å…³é”®è¯æœç´¢ã€å‰§é›†æŽ¨èï¼ˆæ‰‹åŠ¨å¡«å‚ï¼‰",
    author: "VEUS",
    site: "https://github.com/InchStudio/ForwardWidgets",
    version: "3.3.0",
    requiredVersion: "0.0.1",
    detailCacheDuration: 60,

    modules: [
      {
        title: "ðŸ“‚ é¢‘é“åˆ†ç±»",
        description: "å…ˆé€‰åˆ†ç±»ï¼Œå†åŠ è½½é¢‘é“",
        requiresWebView: false,
        functionName: "getCategories",
        cacheDuration: 3600,
        params: [
          { name: "host",     title: "æœåŠ¡å™¨åœ°å€", type: "input", placeholder: "https://lot77162.cdngold.me" },
          { name: "username", title: "ç”¨æˆ·å",     type: "input" },
          { name: "password", title: "å¯†ç ",       type: "input" }
        ]
      },
      {
        title: "ðŸ“º é¢‘é“åˆ—è¡¨",
        description: "åˆ†ç±» + å…³é”®è¯ + åˆ†é¡µ",
        requiresWebView: false,
        functionName: "getChannels",
        sectionMode: true,
        cacheDuration: 300,
        params: [
          { name: "host",       title: "æœåŠ¡å™¨åœ°å€", type: "input" },
          { name: "username",   title: "ç”¨æˆ·å",     type: "input" },
          { name: "password",   title: "å¯†ç ",       type: "input" },
          { name: "categoryId", title: "åˆ†ç±» ID",    type: "enumeration", enumOptions: [] },
          { name: "keyword",    title: "å…³é”®è¯",     type: "input", placeholder: "CCTV / HBO ..." },
          { name: "page",       title: "é¡µç ",       type: "page", value: 1 },
          { name: "size",       title: "æ¯é¡µæ¡æ•°",   type: "constant", value: 50 }
        ]
      }
    ],

    search: {
      title: "ðŸ” å…¨å±€æœç´¢",
      functionName: "getChannels",
      params: [
        { name: "host",     type: "input" },
        { name: "username", type: "input" },
        { name: "password", type: "input" },
        { name: "keyword",  type: "input" }
      ]
    }
  };

  /* ---------- å·¥å…·å‡½æ•° ---------- */
  function parseHost(raw) {
    if (!raw) throw new Error("è¯·å¡«å†™æœåŠ¡å™¨åœ°å€");
    return /^https?:\/\//.test(raw) ? raw : "http://" + raw;
  }

  /* ---------- åˆ†ç±»åˆ—è¡¨ ---------- */
  async function getCategories(params = {}) {
    const { host: rawHost, username, password } = params;
    if (!rawHost || !username || !password) throw new Error("ç¼ºå°‘æœåŠ¡å™¨åœ°å€ / ç”¨æˆ·å / å¯†ç ");

    const host = parseHost(rawHost);
    const api  = `${host}/player_api.php?username=${username}&password=${password}&action=get_live_categories`;
    const res  = await Widget.http.get(api, { headers: { "User-Agent": "AptvPlayer/1.4.11" } });
    if (!Array.isArray(res.data)) throw new Error("åˆ†ç±»æŽ¥å£è¿”å›žå¼‚å¸¸");

    return res.data.map(c => ({
      id: String(c.category_id),
      type: "link",
      title: c.category_name || "æœªåˆ†ç±»",
      link: `${host}/player_api.php?username=${username}&password=${password}&action=get_live_streams&category_id=${c.category_id}`
    }));
  }

  /* ---------- é¢‘é“åˆ—è¡¨ ---------- */
  async function getChannels(params = {}) {
    const { host: rawHost, username, password, categoryId, keyword, page = 1, size = 50 } = params;
    if (!rawHost || !username || !password) throw new Error("ç¼ºå°‘æœåŠ¡å™¨åœ°å€ / ç”¨æˆ·å / å¯†ç ");

    const host = parseHost(rawHost);
    let api    = `${host}/player_api.php?username=${username}&password=${password}&action=get_live_streams`;
    if (categoryId && categoryId !== "0") api += `&category_id=${categoryId}`;

    const res = await Widget.http.get(api, { headers: { "User-Agent": "AptvPlayer/1.4.11" } });
    if (!Array.isArray(res.data)) throw new Error("é¢‘é“æŽ¥å£è¿”å›žå¼‚å¸¸");

    let list = res.data;
    if (keyword) {
      const kw = keyword.toLowerCase();
      list = list.filter(ch => (ch.name || "").toLowerCase().includes(kw));
    }

    const total  = list.length;
    const offset = (page - 1) * size;
    list = list.slice(offset, offset + size);

    if (!list.length && page === 1) {
      return [{ id: "empty", type: "url", title: "âš ï¸ æ— åŒ¹é…é¢‘é“", description: "" }];
    }

    return list.map(ch => ({
      id: `${host}/live/${username}/${password}/${ch.stream_id}.ts`,
      type: "url",
      title: ch.name,
      posterPath: ch.stream_icon || `https://fakeimg.pl/200x300/1C1C1E/ffffff?text=${encodeURIComponent(ch.name)}`,
      backdropPath: ch.stream_icon,
      mediaType: "tv",
      genreTitle: ch.category_name || "",
      description: ch.category_name || "",
      videoUrl: `${host}/live/${username}/${password}/${ch.stream_id}.ts`,
      customHeaders: { "User-Agent": "AptvPlayer/1.4.11" },

      childItems: ch.series && Array.isArray(ch.series)
        ? ch.series.map(ep => ({
            id: `${host}/series/${username}/${password}/${ep.id}.mp4`,
            type: "url",
            title: ep.title || ep.name,
            videoUrl: `${host}/series/${username}/${password}/${ep.id}.mp4`,
            customHeaders: { "User-Agent": "AptvPlayer/1.4.11" }
          }))
        : undefined
    }));
  }

  /* ---------- å¯¼å‡º ---------- */
  globalThis.WidgetMetadata = WidgetMetadata;
  globalThis.getCategories  = getCategories;
  globalThis.getChannels    = getChannels;
})();
