/* ---------- WidgetMetadata ---------- */
var WidgetMetadata = {
  id: "xtream_api_enhance",
  title: "Xtream API Live",
  description: "Fetch live channels via official Xtream-Codes REST API with keyword search",
  author: "ðŸŽ Discount Codeï¼šVEUS",
  site: "ðŸŽ Discount Codeï¼šVEUS",
  version: "2.9.0",
  requiredVersion: "0.0.1",
  detailCacheDuration: 60,
  modules: [
    {
      title: "Channel List",
      description: "REST API â†’ channel cards",
      requiresWebView: false,
      functionName: "getChannels",
      cacheDuration: 300,
      params: [
        { name: "m3u_url", type: "input", placeholder: "http://host/get.php?username=xxx&password=xxx&type=m3u_plus" },
        { name: "host", type: "input", placeholder: "lot77162.cdngold.me" },
        { name: "username", type: "input" },
        { name: "password", type: "input" },
        { name: "keyword", type: "input", placeholder: "CCTV, Sports..." },
        { name: "protocol", type: "enumeration", enumOptions: [
            { title: "HTTP", value: "http" },
            { title: "HTTPS", value: "https" }
          ], default: "http" },
        { name: "ua", type: "input", placeholder: "Forward/1.3.2" },
        { name: "bg_color", type: "input", placeholder: "1C1C1E" }
      ]
    }
  ]
};

/* ---------- ä¸»å‡½æ•° ---------- */
async function getChannels(params = {}) {
  let { host, username, password, keyword, bg_color, ua, protocol } = params;

  /* è§£æž M3U é“¾æŽ¥ */
  if (!host && params.m3u_url) {
    const p = parseM3uUrl(params.m3u_url);
    if (p) ({ host, username, password, protocol } = p);
  }
  if (!host || !username || !password) throw new Error("è¯·å¡«å†™ host / username / passwordï¼Œæˆ–ç›´æŽ¥ç²˜è´´ M3U é“¾æŽ¥");

  const UA = ua || "Forward/1.3.2";               // â† å…¨éƒ¨ç»Ÿä¸€
  const base = `${protocol}://${host}/player_api.php?username=${username}&password=${password}`;
  const kw = keyword ? keyword.trim().toLowerCase() : "";

  const [liveCats, vodCats, serCats] = await Promise.all([
    api(`${base}&action=get_live_categories`, UA),
    api(`${base}&action=get_vod_categories`, UA),
    api(`${base}&action=get_series_categories`, UA)
  ]);

  const cards = [];
  liveCats.slice(0, 30).forEach(c => cards.push(catCard("ðŸ“º Live", c, "live", base, UA)));
  vodCats.slice(0, 30).forEach(c => cards.push(catCard("ðŸŽ¬ VOD", c, "vod", base, UA)));
  serCats.slice(0, 30).forEach(c => cards.push(catCard("ðŸ“º Series", c, "series", base, UA)));
  return cards;
}

/* ---------- äºŒçº§å‡½æ•° ---------- */
async function getStreamsByCat({ type, catId, host, username, password, keyword, ua, protocol }) {
  const base = `${protocol}://${host}/player_api.php?username=${username}&password=${password}`;
  const UA = ua || "Forward/1.3.2";
  const kw = keyword ? keyword.trim().toLowerCase() : "";

  let data = [];
  if (type === "live") {
    data = filter(await api(`${base}&action=get_live_streams&category_id=${catId}`, UA), kw);
  } else if (type === "vod") {
    data = filter(await api(`${base}&action=get_vod_streams&category_id=${catId}`, UA), kw);
  } else if (type === "series") {
    data = filter(await api(`${base}&action=get_series&category_id=${catId}`, UA), kw);
  }
  return data.map(it => itemCard(it.name, it,
    `${base.replace("player_api.php", type)}/${it.stream_id}.${type === "live" ? "ts" : (it.container_extension || "mp4")}`,
    type
  ));
}

/* ---------- å·¥å…·å‡½æ•° ---------- */
function parseM3uUrl(raw) {
  try {
    const u = new URL(raw);
    return {
      protocol: u.protocol.slice(0, -1),
      host: u.hostname,
      username: u.searchParams.get("username"),
      password: u.searchParams.get("password")
    };
  } catch { return null; }
}

async function api(url, ua) {
  try {
    const res = await Widget.http.get(url, { headers: { "User-Agent": ua } });
    return Array.isArray(res.data) ? res.data : [];
  } catch (e) {
    console.error("Request failed:", e);
    throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
  }
}

function filter(arr, kw) {
  return kw ? arr.filter(i => (i.name || "").toLowerCase().includes(kw)) : arr;
}

function catCard(icon, cat, type, base, UA) {
  const host = base.match(/https?:\/\/([^\/]+)/)[1];
  const username = base.match(/username=([^&]+)/)[1];
  const password = base.match(/password=([^&]+)/)[1];
  const protocol = base.split("://")[0];
  return {
    id: `${type}_cat_${cat.category_id}`,
    type: "url",
    title: `${icon} ${cat.category_name}`,
    url: `js:getStreamsByCat({type:"${type}",catId:${cat.category_id},host:"${host}",username:"${username}",password:"${password}",protocol:"${protocol}",ua:"${UA}"})`,
    backdropPath: `https://fakeimg.pl/200x120/1C1C1E/?text=${encodeURIComponent(cat.category_name)}`
  };
}

function itemCard(title, obj, url, media) {
  return {
    id: url,
    type: "url",
    title,
    description: obj.category_name || "",
    posterPath: obj.stream_icon || "",
    backdropPath: obj.stream_icon || "",
    mediaType: media === "live" ? "tv" : "movie",
    videoUrl: url
  };
}
