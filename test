/* ---------- Widget Metadata ---------- */
var WidgetMetadata = {
  id: "xtream_api_v3",
  title: "Xtream Live v3",
  description: "æ”¯æŒ HTTPSã€URL ä¼ å‚ã€åˆ†ç±»åˆ†é¡µã€å…³é”®è¯æœç´¢ã€ç›¸å…³å‰§é›†æ¨è",
  author: "VEUS",
  site: "https://github.com/InchStudio/ForwardWidgets",
  version: "3.0.0",
  requiredVersion: "0.0.1",
  detailCacheDuration: 60,

  modules: [
    /* 0) åˆ†ç±»åˆ—è¡¨ */
    {
      title: "ğŸ“‚ é¢‘é“åˆ†ç±»",
      description: "å…ˆé€‰åˆ†ç±»ï¼Œå†åŠ è½½é¢‘é“",
      functionName: "getCategories",
      cacheDuration: 3600,
      params: [
        { name: "url", type: "input", placeholder: "https://lot77162.cdngold.me" },
        { name: "username", type: "input" },
        { name: "password", type: "input" }
      ]
    },
    /* 1) æŒ‰åˆ†ç±» + åˆ†é¡µ + å…³é”®è¯ å–é¢‘é“ */
    {
      title: "ğŸ“º é¢‘é“åˆ—è¡¨",
      description: "åˆ†ç±» + å…³é”®è¯ + åˆ†é¡µ",
      functionName: "getChannels",
      sectionMode: true,            // å…è®¸â€œç‚¹å‡»æŸ¥çœ‹æ›´å¤šâ€
      cacheDuration: 300,
      params: [
        { name: "url", type: "input" },
        { name: "username", type: "input" },
        { name: "password", type: "input" },
        { name: "categoryId", type: "constant", value: "0" }, // 0 = å…¨éƒ¨
        { name: "keyword", type: "input", placeholder: "CCTV / HBO ..." },
        { name: "page", type: "page", value: 1 },
        { name: "size", type: "constant", value: 50 }          // æ¯é¡µæ¡æ•°
      ]
    }
  ],

  /* å…¨å±€æœç´¢ï¼ˆè·¨åˆ†ç±»ï¼‰ */
  search: {
    title: "ğŸ” å…¨å±€æœç´¢",
    functionName: "getChannels",
    params: [
      { name: "url", type: "input" },
      { name: "username", type: "input" },
      { name: "password", type: "input" },
      { name: "keyword", type: "input" }
    ]
  }
};

/* ==================== å·¥å…·å‡½æ•° ==================== */
// 1) ä»å®Œæ•´ URL é‡ŒæŠ½å‡º protocol://host
function parseHost(raw) {
  if (!raw) return "";
  const m = raw.match(/^(https?:\/\/[^/]+)/i);
  return m ? m[1] : `http://${raw}`;
}

// 2) ä» URL å‚æ•°è‡ªåŠ¨å¡«å……
function fillFromQuery(params) {
  if (params.url) return; // å·²æ‰‹åŠ¨å¡«è¿‡
  try {
    const u = new URL(location.href); // ä»…æµè§ˆå™¨ç¯å¢ƒ
    params.url   = u.searchParams.get("url")   || "";
    params.username = u.searchParams.get("username") || "";
    params.password = u.searchParams.get("password") || "";
  } catch (_) {}
}

/* ---------- 0) åˆ†ç±»åˆ—è¡¨ ---------- */
async function getCategories(params = {}) {
  fillFromQuery(params);
  const { url: rawUrl, username, password } = params;
  if (!rawUrl || !username || !password) {
    throw new Error("âš ï¸ è¯·å¡«å†™å®Œæ•´æœåŠ¡å™¨åœ°å€ / ç”¨æˆ·å / å¯†ç ");
  }
  const host = parseHost(rawUrl);
  const api = `${host}/player_api.php?username=${username}&password=${password}&action=get_live_categories`;
  const res = await Widget.http.get(api, { headers: { "User-Agent": "AptvPlayer/1.4.11" } });
  if (!Array.isArray(res.data)) throw new Error("âŒ åˆ†ç±»æ¥å£è¿”å›å¼‚å¸¸");

  return res.data.map(c => ({
    id: c.category_id,
    type: "link",
    title: c.category_name || "æœªåˆ†ç±»",
    link: "forward://getChannels?" +
          `url=${encodeURIComponent(rawUrl)}&username=${encodeURIComponent(username)}` +
          `&password=${encodeURIComponent(password)}&categoryId=${c.category_id}`
  }));
}

/* ---------- 1) é¢‘é“åˆ—è¡¨ï¼ˆåˆ†é¡µã€å…³é”®è¯ã€åˆ†ç±»è¿‡æ»¤ï¼‰ ---------- */
async function getChannels(params = {}) {
  fillFromQuery(params);
  const { url: rawUrl, username, password, categoryId, keyword, page = 1, size = 50 } = params;
  if (!rawUrl || !username || !password) {
    throw new Error("âš ï¸ è¯·å¡«å†™å®Œæ•´æœåŠ¡å™¨åœ°å€ / ç”¨æˆ·å / å¯†ç ");
  }
  const host = parseHost(rawUrl);
  const api = `${host}/player_api.php?username=${username}&password=${password}&action=get_live_streams`;
  const res = await Widget.http.get(api, { headers: { "User-Agent": "AptvPlayer/1.4.11" } });
  if (!Array.isArray(res.data)) throw new Error("âŒ é¢‘é“æ¥å£è¿”å›å¼‚å¸¸");

  /* è¿‡æ»¤ï¼šåˆ†ç±» + å…³é”®è¯ */
  let list = res.data;
  if (categoryId && categoryId !== "0") {
    list = list.filter(ch => String(ch.category_id) === String(categoryId));
  }
  if (keyword) {
    const kw = keyword.toLowerCase();
    list = list.filter(ch => (ch.name || "").toLowerCase().includes(kw));
  }

  /* åˆ†é¡µ */
  const total = list.length;
  const offset = (page - 1) * size;
  list = list.slice(offset, offset + size);

  /* æ„é€ ç»“æœ */
  const items = list.map(ch => ({
    id: `${host}/live/${username}/${password}/${ch.stream_id}.ts`,
    type: "url",
    title: ch.name,
    backdropPath: ch.stream_icon || `https://fakeimg.pl/400x225/1C1C1E/ffffff?text=${encodeURIComponent(ch.name)}`,
    genreTitle: ch.category_name || "",
    description: ch.category_name || "",
    videoUrl: `${host}/live/${username}/${password}/${ch.stream_id}.ts`,
    customHeaders: { "User-Agent": "AptvPlayer/1.4.11" },

    /* 5) å¦‚æœåŒä¸€ JSON é‡Œè¿˜æœ‰ VOD å¤šé›†ï¼Œä»¥ childItems æ¨è */
    childItems: ch.series ? ch.series.map(ep => ({
      id: `${host}/series/${username}/${password}/${ep.id}.mp4`,
      type: "url",
      title: `ğŸ“º ${ep.title || ep.name}`,
      videoUrl: `${host}/series/${username}/${password}/${ep.id}.mp4`,
      customHeaders: { "User-Agent": "AptvPlayer/1.4.11" }
    })) : undefined
  }));

  /* å¦‚æœè¿˜æœ‰æ›´å¤šï¼Œç”Ÿæˆåˆ†é¡µæŒ‰é’® */
  if (offset + size < total) {
    items.push({
      id: `nextPage_${page + 1}`,
      type: "link",
      title: `â¡ï¸ åŠ è½½ç¬¬ ${page + 1} é¡µ`,
      link: "forward://getChannels?" +
            `url=${encodeURIComponent(rawUrl)}&username=${encodeURIComponent(username)}` +
            `&password=${encodeURIComponent(password)}&categoryId=${categoryId || 0}` +
            `&keyword=${encodeURIComponent(keyword || "")}&page=${page + 1}`
    });
  }
  return items;
}
