/* =========================
   Xtream Live v3.1 â€“ å®Œæ•´åˆè§„ç‰ˆ
   ========================= */
var WidgetMetadata = {
  id: "xtream_live_v31",
  title: "Xtream Live v3.1",
  description: "æ”¯æŒ HTTPSã€URL ä¼ å‚ã€åˆ†ç±»åˆ†é¡µã€å…³é”®è¯æœç´¢ã€ç›¸å…³å‰§é›†",
  author: "VEUS",
  site: "https://github.com/InchStudio/ForwardWidgets",
  version: "3.1.0",
  requiredVersion: "0.0.1",
  detailCacheDuration: 60,

  modules: [
    /* 0ï¸âƒ£ é¢‘é“åˆ†ç±»ï¼ˆä½œä¸ºå…¥å£ï¼‰ */
    {
      title: "ğŸ“‚ é¢‘é“åˆ†ç±»",
      description: "å…ˆé€‰åˆ†ç±»ï¼Œå†åŠ è½½é¢‘é“",
      requiresWebView: false,
      functionName: "getCategories",
      cacheDuration: 3600,
      params: [
        { name: "url",      title: "æœåŠ¡å™¨åœ°å€", type: "input", placeholder: "https://lot77162.cdngold.me" },
        { name: "username", title: "ç”¨æˆ·å",     type: "input" },
        { name: "password", title: "å¯†ç ",       type: "input" }
      ]
    },

    /* 1ï¸âƒ£ é¢‘é“åˆ—è¡¨ï¼ˆåˆ†é¡µ + å…³é”®è¯ï¼‰ */
    {
      title: "ğŸ“º é¢‘é“åˆ—è¡¨",
      description: "æ”¯æŒåˆ†ç±»ã€å…³é”®è¯ã€åˆ†é¡µ",
      requiresWebView: false,
      functionName: "getChannels",
      sectionMode: true,                       // ç”±æ¡†æ¶ç”Ÿæˆâ€œåŠ è½½æ›´å¤šâ€
      cacheDuration: 300,
      params: [
        { name: "url",        title: "æœåŠ¡å™¨åœ°å€", type: "input" },
        { name: "username",   title: "ç”¨æˆ·å",     type: "input" },
        { name: "password",   title: "å¯†ç ",       type: "input" },
        { name: "categoryId", title: "åˆ†ç±» ID",    type: "enumeration", enumOptions: [] }, // è¿è¡ŒæœŸå¡«å……
        { name: "keyword",    title: "å…³é”®è¯",     type: "input", placeholder: "CCTV / HBO ..." },
        { name: "page",       title: "é¡µç ",       type: "page", value: 1 },
        { name: "size",       title: "æ¯é¡µæ¡æ•°",   type: "constant", value: 50 }
      ]
    }
  ],

  /* ğŸ” å…¨å±€æœç´¢ï¼ˆè·¨åˆ†ç±»ï¼‰ */
  search: {
    title: "ğŸ” å…¨å±€æœç´¢",
    functionName: "getChannels",
    params: [
      { name: "url",      type: "input" },
      { name: "username", type: "input" },
      { name: "password", type: "input" },
      { name: "keyword",  type: "input" }
    ]
  }
};

/* =========================
   å·¥å…·å‡½æ•°
   ========================= */
/* ç»Ÿä¸€è§£æ hostï¼›è‡ªåŠ¨è¡¥ http(s) */
function parseHost(raw) {
  if (!raw) throw new Error("æœåŠ¡å™¨åœ°å€ä¸èƒ½ä¸ºç©º");
  const m = raw.match(/^(https?:\/\/)?([^/]+)/i);
  const protocol = m && m[1] ? "" : "http://"; // é»˜è®¤ httpï¼Œå¯æ‰‹åŠ¨å†™ https://
  return `${protocol}${m ? m[2] : raw}`;
}

/* ä»å½“å‰ URL query é‡Œè‡ªåŠ¨å¡«å……å‚æ•° */
function fillFromQuery(params) {
  try {
    const u = new URL(location.href);
    params.url      = u.searchParams.get("url")      || params.url      || "";
    params.username = u.searchParams.get("username") || params.username || "";
    params.password = u.searchParams.get("password") || params.password || "";
  } catch (_) {}
}

/* =========================
   0ï¸âƒ£ è·å–åˆ†ç±»
   ========================= */
async function getCategories(params = {}) {
  fillFromQuery(params);
  const { url: rawUrl, username, password } = params;
  if (!rawUrl || !username || !password) {
    throw new Error("âš ï¸ è¯·å¡«å†™å®Œæ•´æœåŠ¡å™¨åœ°å€ / ç”¨æˆ·å / å¯†ç ");
  }
  const host = parseHost(rawUrl);
  const api  = `${host}/player_api.php?username=${username}&password=${password}&action=get_live_categories`;
  const res  = await Widget.http.get(api, {
    headers: { "User-Agent": "AptvPlayer/1.4.11" }
  }).catch(e => { throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š" + e.message); });

  if (!Array.isArray(res.data)) throw new Error("âŒ åˆ†ç±»æ¥å£è¿”å›å¼‚å¸¸");

  return res.data.map(c => ({
    id: String(c.category_id),
    type: "link",
    title: c.category_name || "æœªåˆ†ç±»",
    /* ç‚¹å‡»åè¿›å…¥é¢‘é“åˆ—è¡¨ï¼Œå¸¦ä¸Šåˆ†ç±» ID */
    link: "forward://getChannels?" +
          `url=${encodeURIComponent(rawUrl)}&username=${encodeURIComponent(username)}` +
          `&password=${encodeURIComponent(password)}&categoryId=${c.category_id}`
  }));
}

/* =========================
   1ï¸âƒ£ è·å–é¢‘é“ï¼ˆåˆ†é¡µã€å…³é”®è¯ã€åˆ†ç±»è¿‡æ»¤ï¼‰
   ========================= */
async function getChannels(params = {}) {
  fillFromQuery(params);
  const { url: rawUrl, username, password, categoryId, keyword, page = 1, size = 50 } = params;
  if (!rawUrl || !username || !password) {
    throw new Error("âš ï¸ è¯·å¡«å†™å®Œæ•´æœåŠ¡å™¨åœ°å€ / ç”¨æˆ·å / å¯†ç ");
  }
  const host = parseHost(rawUrl);
  const api  = `${host}/player_api.php?username=${username}&password=${password}&action=get_live_streams`;
  const res  = await Widget.http.get(api, {
    headers: { "User-Agent": "AptvPlayer/1.4.11" }
  }).catch(e => { throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š" + e.message); });

  if (!Array.isArray(res.data)) throw new Error("âŒ é¢‘é“æ¥å£è¿”å›å¼‚å¸¸");

  /* è¿‡æ»¤ï¼šåˆ†ç±» + å…³é”®è¯ */
  let list = res.data;
  if (categoryId && categoryId !== "0") {
    list = list.filter(ch => String(ch.category_id) === String(categoryId));
  }
  if (keyword) {
    const kw = keyword.toLowerCase();
    list = list.filter(ch => (ch.name || "").toLowerCase().includes(kw));
  }

  /* åˆ†é¡µ */
  const total  = list.length;
  const offset = (page - 1) * size;
  list = list.slice(offset, offset + size);

  /* ç©ºç»“æœæç¤º */
  if (!list.length && page === 1) {
    return [{ id: "empty", type: "url", title: "âš ï¸ æ— åŒ¹é…é¢‘é“", description: "æ¢ä¸ªå…³é”®è¯è¯•è¯•ï¼Ÿ" }];
  }

  /* æ„é€ è¿”å›æ•°æ® */
  const items = list.map(ch => ({
    id: `${host}/live/${username}/${password}/${ch.stream_id}.ts`,
    type: "url",
    title: ch.name,
    posterPath: ch.stream_icon || `https://fakeimg.pl/200x300/1C1C1E/ffffff?font_size=22&text=${encodeURIComponent(ch.name)}`,
    backdropPath: ch.stream_icon,
    mediaType: "tv",
    genreTitle: ch.category_name || "å…¶ä»–",
    description: ch.category_name || "",
    videoUrl: `${host}/live/${username}/${password}/${ch.stream_id}.ts`,
    customHeaders: { "User-Agent": "AptvPlayer/1.4.11" },

    /* è‹¥åŒä¸€ JSON æœ‰å‰§é›†ä¿¡æ¯ï¼Œå¯å±•å¼€ */
    childItems: ch.series && Array.isArray(ch.series)
      ? ch.series.map(ep => ({
          id: `${host}/series/${username}/${password}/${ep.id}.mp4`,
          type: "url",
          title: `ğŸ“º ${ep.title || ep.name}`,
          videoUrl: `${host}/series/${username}/${password}/${ep.id}.mp4`,
          customHeaders: { "User-Agent": "AptvPlayer/1.4.11" }
        }))
      : undefined
  }));

  /* sectionMode ä¼šè‡ªåŠ¨è¿½åŠ â€œåŠ è½½æ›´å¤šâ€ï¼Œæ— éœ€æ‰‹åŠ¨å†™ link */
  return items;
}
