/* ---------- Widget Metadata ---------- */
var WidgetMetadata = {
  id: "xtream_port80",
  title: "Xtream 80ç«¯å£ä¸“ç”¨",
  description: "å›ºå®šç«¯å£80ï¼ŒUA Forward/1.3.2ï¼Œç›´æŽ¥ç²˜è´´å®Œæ•´APIé“¾æŽ¥å³å¯",
  author: "2kuai",
  version: "5.2.0",
  requiredVersion: "0.0.1",
  modules: [{
    title: "è§£æž & æµè§ˆ",
    functionName: "main",
    params: [
      { name: "xtream_url", title: "å®Œæ•´APIé“¾æŽ¥", type: "input",
        placeholder: "http://lot77162.cdngold.me/player_api.php?username=Ahmedalrufaidy&password=h7cy07dp31&action=get_live_streams" },
      { name: "keyword", title: "å…³é”®è¯è¿‡æ»¤", type: "input", placeholder: "ç•™ç©ºæ˜¾ç¤ºå…¨éƒ¨" }
    ]
  }]
};

/* ---------- ä¸»å‡½æ•° ---------- */
async function main(params = {}) {
  const { xtream_url, keyword = "" } = params;
  if (!xtream_url) throw new Error("è¯·ç²˜è´´å®Œæ•´APIé“¾æŽ¥");

  /* 1. è§£æž URLï¼ˆç«¯å£å¼ºåˆ¶ 80ï¼‰*/
  const { host, username, password } = parseUrl(xtream_url);
  const baseUrl = `http://${host}:80`;
  const kw = keyword.trim().toLowerCase();

  /* 2. è°ƒè¯•æ—¥å¿— */
  console.log("è¯·æ±‚URL:", `${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_live_streams`);

  /* 3. æ‹‰å–åˆ†ç±» */
  const liveCats   = await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_live_categories`);
  const vodCats    = await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_vod_categories`);
  const seriesCats = await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_series_categories`);

  /* 4. æ‹‰å–å†…å®¹å¹¶è¿‡æ»¤ */
  const liveChans  = filter(await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_live_streams`), kw);
  const vodMovies  = filter(await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_vod_streams`), kw);
  const seriesList = filter(await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_series`), kw);

  /* 5. æ£€æŸ¥ç©ºæ•°ç»„ */
  if (!liveChans.length && !vodMovies.length && !seriesList.length) {
    throw new Error("æœåŠ¡å™¨è¿”å›žç©ºæ•°ç»„ï¼Œè¯·æ£€æŸ¥è´¦å·ã€ç«¯å£æˆ–é¢æ¿åœ°å€");
  }

  /* 6. ç»„è£…å¡ç‰‡ */
  const cards = [];

  /* 6-1 åˆ†ç±»å…¥å£ */
  liveCats.forEach(c => cards.push(entry("ðŸ“º Live", c.category_name, c.category_id, baseUrl, "live")));
  vodCats.forEach(c  => cards.push(entry("ðŸŽ¬ VOD",  c.category_name, c.category_id, baseUrl, "vod")));
  seriesCats.forEach(c=> cards.push(entry("ðŸ“º Series", c.category_name, c.category_id, baseUrl, "series")));

  /* 6-2 ç›´æ’­é¢‘é“ï¼ˆå‰ 30ï¼‰ */
  liveChans.slice(0, 30).forEach(ch => cards.push(card(ch.name, ch, `${baseUrl}/live/${username}/${password}/${ch.stream_id}.ts`, "live")));

  /* 6-3 ç”µå½±ï¼ˆå‰ 20ï¼‰ */
  vodMovies.slice(0, 20).forEach(m => cards.push(card(m.name, m, `${baseUrl}/movie/${username}/${password}/${m.stream_id}.${(m.container_extension || 'mp4')}`, "movie")));

  /* 6-4 å‰§é›†ï¼ˆé¦–é›† + ç›¸å…³ 4 é›†ï¼‰ */
  for (const s of seriesList.slice(0, 10)) {
    const infoRes = await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_series_info&series_id=${s.series_id}`);
    const eps = Object.values(infoRes.episodes || {}).flat().slice(0, 5);
    if (!eps.length) continue;

    const mainEp = eps[0];
    const related = eps.slice(1, 5).map(e => card(`S${e.season}E${e.episode_num}`, e, `${baseUrl}/series/${username}/${password}/${e.id}.${e.container_extension || 'mp4'}`, "tv"));
    cards.push({
      id: `series_${s.series_id}_main`,
      type: "url",
      title: `${s.name} - S${mainEp.season}E${mainEp.episode_num}`,
      description: infoRes.info?.plot || s.category_name,
      backdropPath: s.cover || infoRes.info?.cover || "",
      videoUrl: `${baseUrl}/series/${username}/${password}/${mainEp.id}.${mainEp.container_extension || 'mp4'}`,
      childItems: related
    });
  }

  return cards;
}

/* ---------- å·¥å…·å‡½æ•° ---------- */
function parseUrl(url) {
  const [proto, rest] = url.split('://');
  const [hostPort, query] = rest.split('?');
  const [host] = hostPort.split(':');           // ç«¯å£å›ºå®š 80
  const pairs = query.split('&').reduce((o, p) => {
    const [k, v] = p.split('=');
    o[decodeURIComponent(k)] = decodeURIComponent(v || '');
    return o;
  }, {});
  return { protocol: proto, host, port: 80, username: pairs.username, password: pairs.password };
}

async function api(u) {
  const r = await Widget.http.get(u, { headers: { "User-Agent": "Forward/1.3.2" } });
  return Array.isArray(r.data) ? r.data : [];
}

function filter(arr, kw) {
  return kw ? arr.filter(i => (i.name || '').toLowerCase().includes(kw)) : arr;
}

function entry(icon, name, id, base, type) {
  return { id: `${type}_${id}`, type: "url", title: `${icon} ${name}`, description: `ç‚¹å‡»æŸ¥çœ‹ ${type} åˆ—è¡¨`, backdropPath: `https://fakeimg.pl/200x120/1C1C1E/?text=${encodeURIComponent(name)}` };
}

function card(title, obj, url, media) {
  return { id: url, type: "url", title, description: obj.category_name || "", backdropPath: obj.stream_icon || "", videoUrl: url, mediaType: media };
}
