/* ---------- è§„èŒƒå…ƒæ•°æ® ---------- */
var WidgetMetadata = {
  id: "xtream_compat",
  title: "Xtream å…¼å®¹ç‰ˆ",
  description: "ç²˜è´´å®Œæ•´ API é“¾æŽ¥å³å¯ï¼šæ—  URLSearchParamsï¼Œæ”¯æŒåˆ†ç±»/æœç´¢/å‰§é›†æŽ¨è",
  author: "2kuai",
  version: "5.1.0",
  requiredVersion: "0.0.1",
  modules: [{
    title: "è§£æž & æµè§ˆ",
    functionName: "main",
    params: [
      { name: "xtream_url", title: "å®Œæ•´ API é“¾æŽ¥", type: "input",
        placeholder: "https://lot77162.cdngold.me/player_api.php?username=Ahmedalrufaidy&password=h7cy07dp31" },
      { name: "keyword", title: "å…³é”®è¯è¿‡æ»¤", type: "input", placeholder: "ç•™ç©ºæ˜¾ç¤ºå…¨éƒ¨" }
    ]
  }]
};

/* ---------- ä¸»å‡½æ•° ---------- */
async function main(params = {}) {
  const { xtream_url, keyword = "" } = params;
  if (!xtream_url) throw new Error("è¯·ç²˜è´´å®Œæ•´ API é“¾æŽ¥");

  /* 1. çº¯å­—ç¬¦ä¸²è§£æž URL & å‚æ•° */
  const { protocol, host, port, username, password } = parseUrl(xtream_url);
  const baseUrl = `${protocol}://${host}${port ? ':' + port : ''}`;
  const kw = keyword.trim().toLowerCase();

  /* 2. æ‹‰å–åˆ†ç±» */
  const liveCats   = await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_live_categories`);
  const vodCats    = await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_vod_categories`);
  const seriesCats = await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_series_categories`);

  /* 3. æ‹‰å–å†…å®¹å¹¶ç­›é€‰ */
  const liveChans  = filter(await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_live_streams`), kw);
  const vodMovies  = filter(await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_vod_streams`), kw);
  const seriesList = filter(await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_series`), kw);

  /* 4. ç»„è£…å¡ç‰‡ */
  const cards = [];

  /* 4-1 åˆ†ç±»å…¥å£ */
  liveCats.forEach(c => cards.push(entry("ðŸ“º Live", c.category_name, c.category_id, baseUrl, "live")));
  vodCats.forEach(c  => cards.push(entry("ðŸŽ¬ VOD",  c.category_name, c.category_id, baseUrl, "vod")));
  seriesCats.forEach(c=> cards.push(entry("ðŸ“º Series", c.category_name, c.category_id, baseUrl, "series")));

  /* 4-2 ç›´æ’­é¢‘é“ï¼ˆå‰ 30ï¼‰ */
  liveChans.slice(0, 30).forEach(ch => cards.push(card(ch.name, ch, `${baseUrl}/live/${username}/${password}/${ch.stream_id}.ts`, "live")));

  /* 4-3 ç”µå½±ï¼ˆå‰ 20ï¼‰ */
  vodMovies.slice(0, 20).forEach(m => cards.push(card(m.name, m, `${baseUrl}/movie/${username}/${password}/${m.stream_id}.${(m.container_extension || 'mp4')}`, "movie")));

  /* 4-4 å‰§é›†ï¼ˆç¬¬ä¸€é›† + ç›¸å…³ 4 é›†ï¼‰ */
  for (const s of seriesList.slice(0, 10)) {
    const infoRes = await api(`${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_series_info&series_id=${s.series_id}`);
    const eps = Object.values(infoRes.episodes || {}).flat().slice(0, 5);
    if (eps.length === 0) continue;

    const mainEp = eps[0];
    const related = eps.slice(1, 5).map(e => card(`S${e.season}E${e.episode_num}`, e, `${baseUrl}/series/${username}/${password}/${e.id}.${e.container_extension || 'mp4'}`, "tv"));
    cards.push({
      id: `series_${s.series_id}_main`,
      type: "url",
      title: `${s.name} - S${mainEp.season}E${mainEp.episode_num}`,
      description: infoRes.info?.plot || s.category_name,
      backdropPath: s.cover || infoRes.info?.cover || "",
      videoUrl: `${baseUrl}/series/${username}/${password}/${mainEp.id}.${mainEp.container_extension || 'mp4'}`,
      childItems: related
    });
  }

  return cards;
}

/* ---------- å·¥å…·å‡½æ•° ---------- */
function parseUrl(url) {
  const [proto, rest] = url.split('://');
  const [hostPort, query] = rest.split('?');
  const [host, port] = hostPort.split(':');
  const pairs = query.split('&').reduce((o, p) => {
    const [k, v] = p.split('=');
    o[decodeURIComponent(k)] = decodeURIComponent(v || '');
    return o;
  }, {});
  return { protocol: proto, host, port, username: pairs.username, password: pairs.password };
}

async function api(u) {
  const r = await Widget.http.get(u, { headers: { "User-Agent": "AptvPlayer/1.4.11" } });
  return Array.isArray(r.data) ? r.data : [];
}

function filter(arr, kw) {
  return kw ? arr.filter(i => (i.name || '').toLowerCase().includes(kw)) : arr;
}

function entry(icon, name, id, base, type) {
  return { id: `${type}_${id}`, type: "url", title: `${icon} ${name}`, description: `ç‚¹å‡»æŸ¥çœ‹ ${type} åˆ—è¡¨`, backdropPath: `https://fakeimg.pl/200x120/1C1C1E/?text=${encodeURIComponent(name)}` };
}

function card(title, obj, url, media) {
  return { id: url, type: "url", title, description: obj.category_name || "", backdropPath: obj.stream_icon || "", videoUrl: url, mediaType: media };
}
